name: Build and Release ZMK Firmware

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
# ──────────────────────────────────────────────────────────────
#  SET-UP build-matrix + keymaps
# ──────────────────────────────────────────────────────────────
  setup:
    runs-on: ubuntu-latest
    outputs:
      groups: ${{ steps.make-groups.outputs.groups }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Upload keymaps
        uses: actions/upload-artifact@v4
        with:
          name: generated-keymaps
          path: config/keymap/

      - name: Generate build matrix
        run: python scripts/generate_matrix.py > build.json

      - id: make-groups
        run: |
          echo "groups=$(jq -c 'map({keymap,format,name,board})' build.json)" >>"$GITHUB_OUTPUT"
          cat build.json | jq .

# ──────────────────────────────────────────────────────────────
#  BUILD
# ──────────────────────────────────────────────────────────────
  build:
    name: Build (${{ matrix.combo.name }})
    needs: setup
    runs-on: ubuntu-latest
    container: zmkfirmware/zmk-build-arm:stable

    strategy:
      fail-fast: false
      matrix:
        combo: ${{ fromJson(needs.setup.outputs.groups) }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Init west workspace
        shell: bash
        run: |
          set -eux
          west init -l --mf $GITHUB_WORKSPACE/config/west.yml $GITHUB_WORKSPACE/config
          west update
          west zephyr-export

      - name: Download keymaps
        uses: actions/download-artifact@v4
        with:
          name: generated-keymaps
          path: config/keymap

      - name: Prepare overlays
        shell: bash
        run: |
          mkdir -p zmk/app/overlays
          if [[ "${{ matrix.combo.format }}" != "reset" ]]; then
            cp config/keymap/${{ matrix.combo.keymap }}.keymap \
               zmk/app/overlays/charybdis.keymap
          fi

      - name: Inject charybdis shields
        if: ${{ matrix.combo.format != 'reset' }}
        shell: bash
        run: |
          mkdir -p zmk/app/boards/shields
          cp -r boards/shields/charybdis_${{ matrix.combo.format }} \
                zmk/app/boards/shields/

      - name: Build firmware
        shell: bash
        working-directory: zmk/app
        run: |
          set -euo pipefail

          FM="${{ matrix.combo.format }}"
          NM="${{ matrix.combo.name }}"
          BD="${{ matrix.combo.board }}"

          declare -A LIST=(
            [bt]="charybdis_bt"
            [dongle]="charybdis_dongle"
            [reset]="settings_reset"
          )

          mkdir -p "$GITHUB_WORKSPACE/out/$NM"

          for SH in ${LIST[$FM]}; do
            BUILD_DIR=$(mktemp -d)

            if [[ "$FM" != "reset" ]]; then
              KEYMAP_OPTION="-DKEYMAP_FILE=overlays/charybdis.keymap"
            else
              KEYMAP_OPTION=""
            fi

            west build -p \
              -d "$BUILD_DIR" \
              -b "$BD" \
              -- \
              "-DZMK_CONFIG=$GITHUB_WORKSPACE/config" \
              "-DSHIELD=$SH" \
              $KEYMAP_OPTION

            ART=$(if [[ -f "$BUILD_DIR/zephyr/zmk.uf2" ]]; then echo zmk.uf2; else echo zmk.bin; fi)
            cp "$BUILD_DIR/zephyr/$ART" "$GITHUB_WORKSPACE/out/$NM/$SH.${ART##*.}"
          done

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: charybdis-${{ matrix.combo.name }}
          path: out/${{ matrix.combo.name }}/
